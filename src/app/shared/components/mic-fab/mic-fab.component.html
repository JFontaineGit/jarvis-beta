<div class="mic-fab-container">
  
  <!-- Manual Input Modal -->
  @if (showManualInput) {
    <div class="manual-input-overlay" (click)="showManualInput = false">
      <div class="manual-input-modal" (click)="$event.stopPropagation()">
        <h3>Escribe tu mensaje</h3>
        <textarea 
          [(ngModel)]="manualText"
          (keydown)="onKeyPress($event)"
          placeholder="Escribe aquí tu mensaje..."
          rows="4"
          maxlength="500"
          #textArea></textarea>
        <div class="char-count">{{ manualText.length }} / 500</div>
        <div class="modal-buttons">
          <button class="btn-cancel" (click)="onManualInputToggle()">
            Cancelar
          </button>
          <button class="btn-send" 
                  (click)="onManualSubmit()" 
                  [disabled]="!manualText.trim()">
            Enviar
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Main Microphone Button with label -->
  <div class="fab-wrapper">
    <button class="fab-button main-fab" 
            [class.listening]="isListening"
            [class.processing]="isProcessing"
            [disabled]="isProcessing"
            (click)="onToggleClick()"
            [attr.aria-label]="isListening ? 'Detener grabación' : 'Iniciar grabación'"
            [title]="isListening ? 'Detener grabación' : 'Iniciar grabación'">
      
      <!-- Ripple effects for listening -->
      @if (isListening) {
        <div class="ripple"></div>
        <div class="ripple delay-1"></div>
        <div class="ripple delay-2"></div>
      }
      
      <!-- Processing spinner -->
      @if (isProcessing) {
        <div class="processing-spinner"></div>
      }
      
      <!-- Microphone icon -->
      @if (!isProcessing) {
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="mic-icon">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
          <line x1="12" y1="19" x2="12" y2="23"/>
          <line x1="8" y1="23" x2="16" y2="23"/>
        </svg>
      }
      
      <!-- Microphone icon -->
      <svg viewBox="0 0 24 24" fill="currentColor" stroke="none" class="mic-fill-icon">
        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
      </svg>
    </button>
    
    <div class="fab-label">
      <span class="label-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
        </svg>
      </span>
      <span class="label-text">Habla con JARVIS</span>
    </div>
  </div>
</div>